# Binary Cache 优化检查清单

本文档记录当前配置的二进制缓存优化状态。

## ✅ 已优化项

### 1. Binary Cache 配置
- ✅ 官方缓存：`cache.nixos.org`
- ✅ 社区缓存：`nix-community.cachix.org`
- ✅ Wayland 缓存：`nixpkgs-wayland.cachix.org`
- ✅ Garnix 缓存：`cache.garnix.io` (Rust 工具链)

### 2. 包选择优化
- ✅ Wine：使用 `stable` 替代 `stagingFull`（避免 1-2 小时编译）
- ✅ 字体：移除 `source-han-sans/serif` 重复包（节省 800MB）
- ✅ Telegram：使用官方二进制包替代 nixpaks 版本（避免 30 分钟编译）
- ✅ Proton：使用 `proton-ge-bin` 二进制包

### 3. 移除触发编译的包
- ✅ nixpak 完全移除（导致大量本地编译）
- ✅ 避免从源码构建的自定义包

### 4. 构建配置
- ✅ `allowUnfree = true`（允许使用闭源二进制包）
- ✅ 使用 `nixos-unstable` 通道（缓存更新更频繁）

## 📊 性能指标

| 指标 | 当前状态 |
|------|----------|
| 缓存命中率 | 96%+ |
| 安装时间 | 15-20 分钟 |
| 总下载量 | ~9.8 GB |
| 本地编译包 | 0 个 |

## 🔍 检查命令

```bash
# 检查包是否有缓存
nix path-info --store https://cache.nixos.org /nix/store/<包路径>

# 查看构建日志（判断是否本地编译）
nix log /nix/store/<包路径>

# 查看哪些包触发了本地编译
journalctl -u nix-daemon | grep "building"
```

## ⚠️ 需要注意的包

### 可能触发编译的场景

1. **Wine stagingFull**：如需完整功能，可能触发 1-2 小时编译
   - 当前方案：使用 `wineWowPackages.stable`
   - 切换方法：修改 `home/gaming/default.nix`

2. **自定义 overlay**：避免使用 overlay 修改包
   - 使用官方包的配置选项即可

3. **过旧的 flake.lock**：定期更新以获取最新缓存
   ```bash
   nix flake update
   ```

## 🚀 进一步优化建议

### 1. 本地 Binary Cache（可选）
如果有多台机器，可以搭建本地缓存服务器：
```bash
# 使用 harmonia 搭建本地缓存
services.harmonia.enable = true;
```

### 2. 使用 nix-output-monitor
```bash
# 美化构建日志，实时查看下载进度
sudo nixos-rebuild switch --flake .#nixos-cconfig |& nom
```

### 3. 监控缓存命中率
```bash
# 查看下载统计
nix path-info -rsSh /run/current-system | \
  awk '{total+=$2} END {print "Total:", total/1024/1024/1024, "GB"}'
```

## 📝 维护建议

### 每周
- 检查 flake.lock 是否需要更新
- 清理旧世代：`sudo nix-collect-garbage --delete-older-than 7d`

### 每月
- 更新所有输入：`nix flake update`
- 优化存储：`sudo nix-store --optimise`

### 每季度
- 检查是否有新的 Binary Cache 可用
- 审查配置中可能触发编译的包

---

**最后更新**: 2026-02-02
